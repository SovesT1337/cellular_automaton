# Обобщенный клеточный автомат - CPU vs CUDA

Вычисление выходной последовательности обобщенного клеточного автомата по заданному графу и функции обратной связи.

## Теория

### Клеточный автомат (КА)
Дискретная вычислительная модель:
- **Сетка ячеек** - каждая имеет состояние (0 или 1)
- **Правило перехода** - определяет новое состояние на основе соседей
- **Дискретное время** - все ячейки обновляются синхронно

### Обобщенный КА
Отличия от классического:
- Топология связей задается **произвольным графом** (не только регулярная сетка)
- Функция обратной связи может быть **произвольной**
- Поддержка **N-мерных** регулярных решеток

### Выходная последовательность
Ключевой компонент задачи - формирование выходной последовательности:

1. **Выбор ячеек**: определяется набор ячеек, значения которых извлекаются
2. **Извлечение**: на каждом шаге (или каждые N шагов) берутся значения выбранных ячеек
3. **Формирование**: значения объединяются в единую последовательность битов

Пример: ячейки {0, 1, 2}, 3 шага
```
Шаг 0: [1, 0, 1] → выходная последовательность: 1 0 1
Шаг 1: [0, 1, 1] → выходная последовательность: 1 0 1 0 1 1
Шаг 2: [1, 1, 0] → выходная последовательность: 1 0 1 0 1 1 1 1 0
```

Выходная последовательность используется в криптографии (генерация псевдослучайных чисел), 
обработке сигналов, и других приложениях.

## Структура проекта

```
cellular_automaton/
├── cellular_automaton.h    # Основные структуры и API
├── benchmark_utils.h       # Утилиты бенчмарков
├── test_configs.h          # Конфигурации 25 тестов
├── benchmark_runner.h      # Класс запуска тестов
├── cpu_automaton.cpp       # CPU реализация (последовательная)
├── cuda_automaton.cu       # CUDA реализация (параллельная)
├── main.cpp                # Бенчмарк CPU vs CUDA (110 строк)
├── main_cpu.cpp            # Только CPU версия
├── README.md               # Документация проекта
├── REFACTORING.md          # Описание рефакторинга
└── RESULTS_REAL.md         # Реальные результаты на RTX 3060
```

## Сборка и запуск

```bash
# С CUDA (требуется NVIDIA GPU и CUDA Toolkit)
make
./cellular_automaton

# Только CPU
make cpu_only
./cellular_automaton_cpu

# С измерением времени
./run_benchmark.sh
```

## Набор тестов

Программа включает **25 разнообразных тестов** (~3 минуты выполнения):

- **Случайные графы** (5 тестов): 10K-10M узлов, степень 3-15
- **1D линии** (2 теста): до 200K ячеек, 2000-3000 шагов
- **2D сетки** (4 теста): до 3000x1000, фон Нейман/Мур
- **3D кубы** (3 теста): до 400x300x200, периодические/открытые
- **4D-5D гиперкубы** (4 теста): до 80^4 и 35^5
- **Крупномасштабные** (7 тестов): до 10M узлов

Каждый тест проверяет:
- ✅ Совпадение результатов CPU/CUDA
- ✅ Формирование выходной последовательности
- ✅ Измерение производительности

## N-мерные решетки

Поддерживаются решетки произвольной размерности:

| Размерность | Пример | Соседи (фон Нейман) | Соседи (Мур) |
|-------------|--------|---------------------|--------------|
| 1D | {1000} | 2 | 2 |
| 2D | {100, 100} | 4 | 8 |
| 3D | {50, 50, 50} | 6 | 26 |
| 4D | {20, 20, 20, 20} | 8 | 80 |
| ND | {d1, d2, ..., dN} | 2N | 3^N - 1 |

### Типы окрестностей

**Фон Нейман**: ортогональные соседи (±1 по одной оси)
```
    [1]
 [1][X][1]
    [1]
```

**Мур**: все соседи включая диагональные
```
 [1][1][1]
 [1][X][1]
 [1][1][1]
```

## Функции обратной связи

| Тип | Описание | Применение |
|-----|----------|------------|
| XOR | Исключающее ИЛИ всех соседей | Криптография, LFSR |
| Majority | Большинство голосов | Консенсус, сглаживание |
| Rule 110 | Универсальный 1D КА | Вычисления (Тьюринг-полный) |

## Формат графа (CSR)

Compressed Sparse Row - эффективный формат для GPU:

```
Граф: 0->1, 0->2, 1->2, 2->0

row_ptr = [0, 2, 3, 4]   # Начало списка соседей
col_idx = [1, 2, 2, 0]   # Индексы соседей

Соседи вершины i: col_idx[row_ptr[i] : row_ptr[i+1]]
```

## Выходные метрики

- **Время выполнения** (мс)
- **Ускорение** (speedup = CPU_time / CUDA_time)
- **Проверка корректности** (совпадение результатов CPU и CUDA)
- **Выходная последовательность** (биты из выбранных ячеек)
- **Пропускная способность** (cells/s)

## Пример вывода

```
╔════════════════════════════════════════════════════════════════╗
║ ТЕСТ: 3D куб 100x100x100                                      ║
╚════════════════════════════════════════════════════════════════╝
Узлов: 1000000, Рёбер: 5940000, Шагов: 50

[CPU] Время: 178.211 мс
[CPU] Конечное состояние: 11010000011101101111...
[CPU] Выходная последовательность (255 бит): 1101100000000010101...

[CUDA] Время: 12.453 мс
[CUDA] Конечное состояние: 11010000011101101111...
[CUDA] Выходная последовательность (255 бит): 1101100000000010101...

┌─────────────────────────────────────────────────────────┐
│ РЕЗУЛЬТАТ: ✓ Совпадение                                 │
│ Ускорение (CPU/CUDA):                           14.31x  │
└─────────────────────────────────────────────────────────┘
```

## Сводная таблица

```
+---------------------------+--------------+--------------+--------------+--------------+
| Тест                      | CPU (мс)     | CUDA (мс)    | Ускорение    | Совпадение   |
+---------------------------+--------------+--------------+--------------+--------------+
| 1K узлов                  | 0.419        | 0.892        | 0.47x        | ДА           |
| 10K узлов                 | 9.810        | 2.134        | 4.60x        | ДА           |
| 100K узлов                | 62.400       | 6.721        | 9.28x        | ДА           |
| 1M узлов                  | 198.097      | 15.332       | 12.92x       | ДА           |
| 2D сетка 500x500          | 74.030       | 8.456        | 8.75x        | ДА           |
| 3D куб 100x100x100        | 178.211      | 12.453       | 14.31x       | ДА           |
+---------------------------+--------------+--------------+--------------+--------------+
```

## График производительности

```
╔════════════════════════════════════════════════════════════════════╗
║         ГРАФИК СРАВНЕНИЯ ПРОИЗВОДИТЕЛЬНОСТИ CPU vs CUDA           ║
╚════════════════════════════════════════════════════════════════════╝

1K узлов                  │
  CPU:  ████ 0.42 мс
  CUDA: █████████ 0.89 мс (ускорение: 0.5x)

10K узлов                 │
  CPU:  ████████████████████████ 9.81 мс
  CUDA: █████ 2.13 мс (ускорение: 4.6x)

100K узлов                │
  CPU:  ████████████████████████████████████████████ 62.40 мс
  CUDA: ████ 6.72 мс (ускорение: 9.3x)

1M узлов                  │
  CPU:  ██████████████████████████████████████████████████████████ 198.10 мс
  CUDA: ████████ 15.33 мс (ускорение: 12.9x)
```

## Параллелизм CUDA

- Каждая ячейка = 1 поток (thread)
- Потоки группируются в блоки по 256
- GPU обрабатывает миллионы ячеек одновременно

```
┌─────────────────────────────────────────┐
│ Grid (все блоки)                        │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐    │
│  │ Block 0 │ │ Block 1 │ │ Block N │    │
│  │ 256 thr │ │ 256 thr │ │ 256 thr │    │
│  └─────────┘ └─────────┘ └─────────┘    │
└─────────────────────────────────────────┘
```

## Выводы

1. **CUDA демонстрирует значительное ускорение** для больших графов (>10K узлов), достигая ускорения до 10-15x.

2. **Для малых графов** (<1K узлов) накладные расходы на передачу данных между CPU и GPU снижают эффективность.

3. **Выходная последовательность формируется корректно** и совпадает между CPU и GPU версиями, подтверждая правильность реализации.

4. **N-мерные решетки эффективно обрабатываются на GPU** благодаря регулярной структуре соседства.

5. **Использование CSR формата графа** обеспечивает эффективный доступ к памяти как на CPU, так и на GPU.

## Требования

- **CPU версия**: C++17, g++ или clang++
- **CUDA версия**: CUDA Toolkit 11.0+, NVIDIA GPU с compute capability 3.5+
- **OS**: Linux (WSL поддерживается), macOS (только CPU), Windows (с CUDA)

## Установка CUDA (Ubuntu/Debian)

```bash
sudo apt-get install cuda-toolkit-13-1

# Добавить в ~/.bashrc
export PATH=/usr/local/cuda/bin:$PATH
export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
```

## Дополнительная документация

- **RESULTS_REAL.md** - полные результаты работы на RTX 3060 с анализом
- **REFACTORING.md** - описание архитектуры и улучшений кода
- **Репозиторий**: https://github.com/SovesT1337/cellular_automaton
